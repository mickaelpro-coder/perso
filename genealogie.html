<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Arbre G√©n√©alogique</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Chalkboard', cursive;
        }

        body {
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8b0 50%, #ffeaa7 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #e17055;
            font-size: 1.8em;
            text-shadow: 2px 2px 0px #fdcb6e;
            margin-bottom: 15px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .tree-icon {
            font-size: 2em;
            display: block;
            text-align: center;
            margin-bottom: 5px;
        }

        /* Bouton de r√©duction des blocs */
        .collapse-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #b2bec3;
            background: white;
            color: #636e72;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .collapse-btn:hover {
            background: #dfe6e9;
            border-color: #636e72;
        }

        .collapsible {
            position: relative;
        }

        .collapsible .collapsible-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .collapsible.collapsed .collapsible-content {
            display: none;
        }

        .collapsible.collapsed .collapse-btn {
            transform: rotate(0deg);
        }

        body.professional .collapse-btn {
            border-radius: 4px;
            border-width: 1px;
        }

        /* Formulaire */
        .form-container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            border: 3px dashed #74b9ff;
            position: relative;
        }

        .form-title {
            color: #6c5ce7;
            text-align: center;
            margin-bottom: 12px;
            font-size: 1.2em;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            color: #e17055;
            font-size: 0.85em;
            margin-bottom: 4px;
        }

        input, select {
            padding: 8px;
            border: 2px solid #dfe6e9;
            border-radius: 10px;
            font-size: 0.85em;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #74b9ff;
            box-shadow: 0 0 10px rgba(116, 185, 255, 0.5);
        }

        .relation-section {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 10px;
            margin-top: 8px;
        }

        .relation-title {
            color: #6c5ce7;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-align: center;
        }

        .relation-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
        }

        .btn {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            font-size: 0.95em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            margin-top: 10px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 15px rgba(232, 67, 147, 0.4);
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.8em;
            margin: 3px;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .btn-container {
            text-align: center;
            grid-column: 1 / -1;
        }

        /* Arbre g√©n√©alogique */
        .tree-container {
            background: white;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 3px dashed #00b894;
            min-height: 400px;
            overflow-x: auto;
            position: relative;
        }

        .tree-container.collapsed {
            min-height: auto;
        }

        .tree-title {
            color: #00b894;
            text-align: center;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .tree-subtitle {
            text-align: center;
            color: #636e72;
            margin-bottom: 10px;
            font-size: 0.75em;
        }

        /* Structure de l'arbre */
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 10px;
            min-width: fit-content;
        }

        .tree-level {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 15px;
            position: relative;
        }

        .tree-level-label {
            position: absolute;
            left: -100px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.65em;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            text-align: center;
            min-width: 80px;
        }

        .tree-level-label .level-emoji {
            display: block;
            font-size: 1.2em;
            margin-bottom: 1px;
        }

        .generation-header {
            text-align: center;
            margin-bottom: 6px;
            padding: 5px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            display: inline-block;
        }

        .generation-header .gen-emoji {
            margin-right: 5px;
        }

        .tree-level-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 3px;
        }

        .empty-level {
            color: #b2bec3;
            font-style: italic;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dfe6e9;
            font-size: 0.8em;
        }

        /* Cartes des personnes */
        .person-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            min-width: 90px;
            max-width: 110px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid;
            cursor: pointer;
        }

        .person-card.male {
            border-color: #74b9ff;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .person-card.female {
            border-color: #fd79a8;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
        }

        .person-card:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .person-card.center {
            border-width: 3px;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            z-index: 10;
            border-color: #e17055;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .person-card.center.male,
        .person-card.center.female {
            border-color: #e17055;
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
        }

        .person-avatar {
            font-size: 1.8em;
            margin-bottom: 4px;
        }

        .person-name {
            font-size: 0.75em;
            color: #2d3436;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .person-birth {
            color: #636e72;
            font-size: 0.65em;
        }

        .person-relation-label {
            background: #6c5ce7;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6em;
            margin-top: 4px;
            display: inline-block;
        }

        .delete-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #ff7675;
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.65em;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .person-card:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            background: #d63031;
        }

        /* Lignes de connexion */
        .connector {
            position: relative;
        }

        .connector-line {
            stroke: #b2bec3;
            stroke-width: 3;
            fill: none;
        }

        .tree-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        /* Groupes avec lignes */
        .tree-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .tree-group::before {
            content: '';
            position: absolute;
            top: -12px;
            width: 2px;
            height: 12px;
            background: #b2bec3;
        }

        .tree-group.no-line::before {
            display: none;
        }

        .tree-row {
            display: flex;
            gap: 10px;
            position: relative;
        }

        .tree-row::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 90px);
            height: 2px;
            background: #b2bec3;
        }

        .tree-row.single::before {
            display: none;
        }

        /* Groupe de fratrie (parent + oncles/tantes) */
        .sibling-group {
            display: flex;
            gap: 8px;
            position: relative;
            padding-top: 15px;
            align-items: flex-start;
        }

        .sibling-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20px;
            right: 20px;
            height: 2px;
            background: #b2bec3;
        }

        .sibling-group .person-card {
            position: relative;
        }

        .sibling-group .person-card::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background: #b2bec3;
        }

        .parents-row {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
        }

        .sibling-group.no-siblings {
            padding-top: 0;
        }

        .sibling-group.no-siblings::before {
            display: none;
        }

        .sibling-group.no-siblings .person-card::before {
            display: none;
        }

        .tree-row > .person-card::before {
            content: '';
            position: absolute;
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 6px;
            background: #b2bec3;
        }

        .vertical-line {
            width: 2px;
            height: 15px;
            background: #b2bec3;
            margin: 0 auto;
        }

        .horizontal-line {
            height: 2px;
            background: #b2bec3;
            position: absolute;
        }

        /* Section de s√©lection des membres */
        .members-list {
            background: white;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            border: 3px dashed #a29bfe;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .members-list-title {
            color: #6c5ce7;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .members-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .member-chip {
            background: white;
            border: 2px solid #dfe6e9;
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.75em;
        }

        .member-chip:hover {
            border-color: #74b9ff;
            background: #e3f2fd;
        }

        .member-chip.active {
            border-color: #6c5ce7;
            background: #e8e4f8;
            font-weight: bold;
        }

        .member-chip .chip-avatar {
            margin-right: 3px;
        }

        /* Groupes par lettre */
        .letter-group {
            width: 100%;
            margin-bottom: 8px;
        }

        .letter-header {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 0.85em;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 6px;
        }

        .letter-members {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: flex-start;
        }

        body.professional .letter-header {
            background: #34495e;
            border-radius: 4px;
        }

        /* Section de gestion des liens */
        .relations-manager {
            background: #fff3e0;
            border-radius: 20px;
            padding: 15px;
            margin-bottom: 15px;
            border: 3px dashed #ffcc80;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .relations-manager-title {
            color: #e65100;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .relations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .relation-item {
            background: white;
            border: 1px solid #ffcc80;
            padding: 4px 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7em;
            transition: all 0.3s ease;
        }

        .relation-item:hover {
            border-color: #ff7043;
            background: #fff8e1;
        }

        .relation-item .relation-text {
            color: #5d4037;
        }

        .relation-item .relation-type {
            background: #6c5ce7;
            color: white;
            padding: 1px 5px;
            border-radius: 6px;
            font-size: 0.75em;
        }

        .relation-delete-btn {
            background: #ff7675;
            color: white;
            border: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.6em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .relation-delete-btn:hover {
            background: #d63031;
            transform: scale(1.1);
        }

        .no-relations {
            color: #9e9e9e;
            text-align: center;
            font-style: italic;
            font-size: 0.8em;
        }

        /* Formulaire d'ajout de lien */
        .add-relation-form {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ffcc80;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
        }

        .add-relation-form select {
            padding: 6px;
            border: 1px solid #ffcc80;
            border-radius: 8px;
            font-size: 0.85em;
            font-family: inherit;
            min-width: 120px;
        }

        .add-relation-form select:focus {
            outline: none;
            border-color: #ff9800;
        }

        .btn-add-relation {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 0.8em;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s ease;
        }

        .btn-add-relation:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(67, 160, 71, 0.4);
        }

        .btn-add-relation:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Messages */
        .message {
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            animation: fadeIn 0.5s ease;
            font-size: 0.85em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background: #55efc4;
            color: #00b894;
        }

        .message.error {
            background: #fab1a0;
            color: #d63031;
        }

        /* Formulaire de modification */
        .edit-form {
            background: #e8f5e9;
            border: 1px solid #81c784;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .edit-form-title {
            color: #2e7d32;
            font-size: 0.85em;
            margin-bottom: 6px;
            text-align: center;
        }

        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 6px;
        }

        .edit-form-group {
            display: flex;
            flex-direction: column;
        }

        .edit-form-group label {
            font-size: 0.7em;
            color: #2e7d32;
            margin-bottom: 2px;
        }

        .edit-form-group input,
        .edit-form-group select {
            padding: 5px;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            font-size: 0.8em;
            font-family: inherit;
        }

        .edit-form-group input:focus,
        .edit-form-group select:focus {
            outline: none;
            border-color: #66bb6a;
        }

        .edit-buttons {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin-top: 8px;
        }

        .btn-save {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            transition: all 0.3s ease;
        }

        .btn-save:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(67, 160, 71, 0.4);
        }

        .btn-cancel {
            background: #bdbdbd;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #9e9e9e;
        }

        /* Checkbox styl√© */
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.8em;
            color: #636e72;
            margin-top: 5px;
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkbox-custom {
            width: 18px;
            height: 18px;
            border: 2px solid #dfe6e9;
            border-radius: 5px;
            margin-right: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: white;
            font-size: 0.7em;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkbox-custom {
            background: #a29bfe;
            border-color: #6c5ce7;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkbox-custom::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
        }

        /* Style pour personne d√©c√©d√©e */
        .person-card.deceased {
            opacity: 0.7;
            filter: grayscale(40%);
        }

        .person-card.deceased .person-avatar::after {
            content: 'üïäÔ∏è';
            font-size: 0.5em;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .person-avatar {
            position: relative;
        }

        .deceased-badge {
            font-size: 0.55em;
            color: #636e72;
            margin-top: 2px;
        }

        .no-members {
            text-align: center;
            color: #b2bec3;
            font-size: 0.9em;
            padding: 30px;
        }

        .no-members span {
            font-size: 2em;
            display: block;
            margin-bottom: 10px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #6c5ce7;
        }

        .loading-spinner {
            font-size: 2em;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            h1 {
                font-size: 1.4em;
            }

            .form-grid, .relation-grid {
                grid-template-columns: 1fr;
            }

            .person-card {
                min-width: 80px;
                max-width: 100px;
                padding: 6px;
            }

            .person-avatar {
                font-size: 1.5em;
            }

            .person-name {
                font-size: 0.65em;
            }

            .tree-level {
                gap: 8px;
            }

            .tree-level-label {
                display: none;
            }
        }

        /* Bouton de bascule */
        /* Conteneur des boutons en haut */
        .top-buttons {
            position: fixed;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
            flex-wrap: wrap;
            justify-content: flex-end;
            max-width: calc(100% - 20px);
        }

        .top-buttons button {
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.75em;
            color: white;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .top-buttons button:hover {
            transform: scale(1.05);
        }

        .toggle-mode {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }

        .toggle-mode:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-birthday {
            background: linear-gradient(135deg, #fdcb6e 0%, #f39c12 100%);
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.4);
        }

        .btn-birthday:hover {
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5);
        }

        body.professional .btn-birthday {
            background: #d68910;
            border-radius: 6px;
        }

        body.professional .top-buttons button {
            border-radius: 6px;
        }

        /* Calendrier des anniversaires */
        .calendar-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }

        .calendar-modal.show {
            display: flex;
        }

        .calendar-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .calendar-title {
            color: #f39c12;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .month-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
        }

        .month-name {
            text-align: center;
            font-weight: bold;
            color: #6c5ce7;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .days-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 4px;
        }

        .day-header {
            text-align: center;
            font-size: 0.6em;
            color: #636e72;
            font-weight: bold;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .day-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6em;
            border-radius: 4px;
            color: #636e72;
        }

        .day-cell.empty {
            background: transparent;
        }

        .day-cell.has-birthday {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }

        .day-cell.has-birthday:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .day-cell.has-birthday .initials {
            font-size: 0.7em;
        }

        .day-cell.has-birthday.male {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        .day-cell.has-birthday.female {
            background: linear-gradient(135deg, #fd79a8 0%, #e84393 100%);
        }

        .day-cell.has-birthday.multiple {
            background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        }

        .birthday-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3436;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            white-space: nowrap;
            display: none;
            z-index: 100;
        }

        .day-cell.has-birthday:hover .birthday-tooltip {
            display: block;
        }

        .calendar-close {
            display: block;
            margin: 20px auto 0;
            background: #b2bec3;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
        }

        .calendar-close:hover {
            background: #636e72;
        }

        body.professional .calendar-content {
            border-radius: 8px;
        }

        body.professional .calendar-title {
            color: #d68910;
        }

        body.professional .month-name {
            color: #2c3e50;
        }

        body.professional .day-cell.has-birthday.male {
            background: #3498db;
        }

        body.professional .day-cell.has-birthday.female {
            background: #9b59b6;
        }

        body.professional .day-cell.has-birthday.multiple {
            background: #34495e;
        }

        .btn-children {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.4);
        }

        .btn-children:hover {
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.5);
        }

        body.professional .btn-children {
            background: #16a085;
        }

        .btn-singles {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            box-shadow: 0 3px 10px rgba(214, 48, 49, 0.4);
        }

        .btn-singles:hover {
            box-shadow: 0 6px 20px rgba(214, 48, 49, 0.5);
        }

        /* Modal pour les c√©libataires */
        .singles-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .singles-modal.show {
            display: flex;
        }

        .singles-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .singles-title {
            color: #e17055;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .singles-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .single-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .single-item:hover {
            background: #e3f2fd;
        }

        .single-item .age {
            color: #636e72;
            font-size: 0.8em;
        }

        .singles-close {
            display: block;
            margin: 15px auto 0;
            background: #b2bec3;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
        }

        .singles-close:hover {
            background: #636e72;
        }

        .no-singles {
            text-align: center;
            color: #636e72;
            padding: 20px;
        }

        body.professional .btn-singles {
            background: #c0392b;
            border-radius: 6px;
        }

        body.professional .singles-content {
            border-radius: 8px;
        }

        body.professional .singles-title {
            color: #c0392b;
        }

        /* Mode Professionnel */
        body.professional {
            background: #f5f6fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.professional * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body.professional .tree-icon {
            display: none;
        }

        body.professional h1 {
            color: #2c3e50;
            text-shadow: none;
            animation: none;
            font-size: 2em;
            font-weight: 600;
        }

        body.professional .form-container {
            border: 1px solid #dcdde1;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body.professional .form-title {
            color: #2c3e50;
            font-weight: 600;
        }

        body.professional .tree-container {
            border: 1px solid #dcdde1;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body.professional .tree-title {
            color: #2c3e50;
        }

        body.professional .btn {
            background: #3498db;
            border-radius: 6px;
        }

        body.professional .btn:hover {
            background: #2980b9;
        }

        body.professional .btn-secondary {
            background: #7f8c8d;
        }

        body.professional .person-card {
            border-radius: 8px;
            border-width: 2px;
        }

        body.professional .person-card.male {
            border-color: #3498db;
            background: #ebf5fb;
        }

        body.professional .person-card.female {
            border-color: #9b59b6;
            background: #f5eef8;
        }

        body.professional .person-card.center,
        body.professional .person-card.center.male,
        body.professional .person-card.center.female {
            border-color: #e67e22;
            background: #fef9e7;
        }

        body.professional .person-avatar {
            font-size: 2em;
        }

        body.professional .person-relation-label {
            background: #34495e;
            border-radius: 4px;
        }

        body.professional .generation-header {
            background: #34495e;
            border-radius: 6px;
            font-weight: 500;
        }

        body.professional .members-list {
            background: #ecf0f1;
            border-radius: 8px;
            border: 1px solid #bdc3c7;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body.professional .member-chip {
            border-radius: 6px;
        }

        body.professional .member-chip.active {
            border-color: #3498db;
            background: #ebf5fb;
        }

        body.professional .relations-manager {
            background: #fdf6e3;
            border: 1px solid #f0c36d;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        body.professional .edit-form {
            background: #e8f6f3;
            border: 1px solid #a3d9c6;
            border-radius: 8px;
        }

        body.professional .checkbox-label {
            color: #2c3e50;
        }

        body.professional .toggle-mode {
            background: #e74c3c;
        }

        body.professional .toggle-mode:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.5);
        }

        body.professional input,
        body.professional select {
            border-radius: 6px;
            border-width: 1px;
        }

        body.professional .btn-save {
            background: #27ae60;
            border-radius: 6px;
        }

        body.professional .btn-add-relation {
            background: #27ae60;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Boutons en haut -->
    <div class="top-buttons">
        <button class="btn-birthday" onclick="showBirthdayCalendar()">üéÇ Anniversaires</button>
        <button class="btn-children" onclick="showChildren()">üë∂ Enfants</button>
        <button class="btn-singles" onclick="showSingles()">üíî Sans conjoint</button>
        <button class="toggle-mode" onclick="toggleMode()">üé® Mode Pro</button>
    </div>

    <!-- Modal du calendrier des anniversaires -->
    <div id="birthdayModal" class="calendar-modal" onclick="closeBirthdayCalendar(event)">
        <div class="calendar-content" onclick="event.stopPropagation()">
            <h3 class="calendar-title">üéÇ Calendrier des Anniversaires</h3>
            <div id="birthdayCalendar" class="calendar-grid"></div>
            <button class="calendar-close" onclick="closeBirthdayCalendar()">Fermer</button>
        </div>
    </div>

    <!-- Modal des enfants -->
    <div id="childrenModal" class="singles-modal" onclick="closeChildrenModal(event)">
        <div class="singles-content" onclick="event.stopPropagation()">
            <h3 class="singles-title" style="color: #00b894;">üë∂ Enfants (moins de 18 ans)</h3>
            <div id="childrenList" class="singles-list"></div>
            <button class="singles-close" onclick="closeChildrenModal()">Fermer</button>
        </div>
    </div>

    <!-- Modal des adultes sans conjoint -->
    <div id="singlesModal" class="singles-modal" onclick="closeSinglesModal(event)">
        <div class="singles-content" onclick="event.stopPropagation()">
            <h3 class="singles-title">üíî Adultes sans conjoint</h3>
            <div id="singlesList" class="singles-list"></div>
            <button class="singles-close" onclick="closeSinglesModal()">Fermer</button>
        </div>
    </div>

    <div class="container">
        <span class="tree-icon">üå≥</span>
        <h1>Mon Arbre G√©n√©alogique</h1>

        <div id="message"></div>

        <!-- Formulaire d'ajout -->
        <div class="form-container collapsible" id="addFormBlock">
            <button class="collapse-btn" onclick="toggleCollapse('addFormBlock')">‚àí</button>
            <h2 class="form-title">Ajouter un membre de la famille</h2>
            <div class="collapsible-content">
            <form id="addMemberForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="prenom">Pr√©nom</label>
                        <input type="text" id="prenom" name="prenom" placeholder="Ex: Marie" required>
                    </div>
                    <div class="form-group">
                        <label for="nom">Nom</label>
                        <input type="text" id="nom" name="nom" placeholder="Ex: Dupont" required>
                    </div>
                    <div class="form-group">
                        <label for="dateNaissance">Date de naissance</label>
                        <input type="text" id="dateNaissance" name="dateNaissance" placeholder="Ex: 1985 ou 15/03/1985">
                    </div>
                    <div class="form-group">
                        <label for="sexe">Sexe</label>
                        <select id="sexe" name="sexe" required>
                            <option value="">Choisir...</option>
                            <option value="M">Gar√ßon</option>
                            <option value="F">Fille</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="decede" name="decede">
                            <span class="checkbox-custom"></span>
                            D√©c√©d√©(e) üïäÔ∏è
                        </label>
                    </div>

                    <div class="relation-section">
                        <div class="relation-title">Parents (optionnel)</div>
                        <div class="relation-grid">
                            <div class="form-group">
                                <label for="pereId">üë® P√®re</label>
                                <select id="pereId" name="pereId">
                                    <option value="">Aucun p√®re</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="mereId">üë© M√®re</label>
                                <select id="mereId" name="mereId">
                                    <option value="">Aucune m√®re</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="btn-container">
                        <button type="submit" class="btn">Ajouter √† la famille</button>
                    </div>
                </div>
            </form>
            </div>
        </div>

        <!-- Gestionnaire de liens (au-dessus de l'arbre) -->
        <div id="relationsManager" class="relations-manager collapsible" style="display: none;">
            <button class="collapse-btn" onclick="toggleCollapse('relationsManager')">‚àí</button>
            <div class="relations-manager-title">Modifier <span id="selectedMemberName"></span></div>
            <div class="collapsible-content">
            <!-- Formulaire de modification -->
            <div class="edit-form">
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label for="editPrenom">Pr√©nom</label>
                        <input type="text" id="editPrenom" placeholder="Pr√©nom">
                    </div>
                    <div class="edit-form-group">
                        <label for="editNom">Nom</label>
                        <input type="text" id="editNom" placeholder="Nom">
                    </div>
                    <div class="edit-form-group">
                        <label for="editDateNaissance">Date de naissance</label>
                        <input type="text" id="editDateNaissance" placeholder="Ex: 1985">
                    </div>
                    <div class="edit-form-group">
                        <label for="editSexe">Sexe</label>
                        <select id="editSexe">
                            <option value="M">Gar√ßon</option>
                            <option value="F">Fille</option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="editDecede">
                            <span class="checkbox-custom"></span>
                            D√©c√©d√©(e) üïäÔ∏è
                        </label>
                    </div>
                </div>
                <div class="edit-buttons">
                    <button type="button" class="btn-save" onclick="saveEditMember()">Enregistrer</button>
                </div>
            </div>

            <div class="relations-manager-title" style="margin-top: 15px;">Liens</div>
            <div id="relationsList" class="relations-list"></div>

            <!-- Formulaire pour ajouter un nouveau lien -->
            <div class="add-relation-form">
                <span style="color: #e65100;">Ajouter un lien :</span>
                <select id="newRelationType">
                    <option value="">Type de lien...</option>
                    <option value="pere">Est le p√®re</option>
                    <option value="mere">Est la m√®re</option>
                    <option value="conjoint">Est le/la conjoint(e)</option>
                </select>
                <select id="newRelatedPerson">
                    <option value="">Personne...</option>
                </select>
                <button type="button" class="btn-add-relation" onclick="addNewRelation()">+ Ajouter</button>
            </div>
            <p style="color: #9e9e9e; font-size: 0.8em; text-align: center; margin-top: 10px;">
                Les fr√®res/s≈ìurs, oncles/tantes, cousins et grands-parents sont calcul√©s automatiquement !
            </p>
            </div>
        </div>

        <!-- Liste des membres pour s√©lection -->
        <div id="membersBlock" class="members-list collapsible">
            <button class="collapse-btn" onclick="toggleCollapse('membersBlock')">‚àí</button>
            <div class="members-list-title">Membres de la famille</div>
            <div class="collapsible-content">
                <div id="membersChips" class="members-chips"></div>
            </div>
        </div>

        <!-- Affichage de l'arbre -->
        <div class="tree-container collapsible" id="treeBlock">
            <button class="collapse-btn" onclick="toggleCollapse('treeBlock')">‚àí</button>
            <h2 class="tree-title">Mon Arbre Familial</h2>
            <div class="collapsible-content">
            <p class="tree-subtitle">Clique sur une personne pour la mettre au centre de l'arbre</p>

            <!-- Arbre g√©n√©alogique -->
            <div id="familyTree" class="family-tree">
                <div class="loading">
                    <span class="loading-spinner">üåª</span>
                    <p>Chargement de la famille...</p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const SUPABASE_URL = 'https://boybuqexjmzvfumfrmfk.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_6SSMn8zMrXuZm6SLrRCHyg_tu4L_Wt4';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let familyMembers = [];
        let familyRelations = [];
        let selectedMemberId = null;
        let isProfessionalMode = false;

        // Basculer entre mode enfant et professionnel
        function toggleMode() {
            isProfessionalMode = !isProfessionalMode;
            document.body.classList.toggle('professional', isProfessionalMode);
            const btn = document.querySelector('.toggle-mode');
            if (isProfessionalMode) {
                btn.textContent = 'üß∏ Mode Enfant';
            } else {
                btn.textContent = 'üé® Mode Pro';
            }
            // Sauvegarder la pr√©f√©rence
            localStorage.setItem('genealogie-mode', isProfessionalMode ? 'pro' : 'enfant');
        }

        // Charger la pr√©f√©rence au d√©marrage
        function loadModePreference() {
            const savedMode = localStorage.getItem('genealogie-mode');
            if (savedMode === 'pro') {
                isProfessionalMode = true;
                document.body.classList.add('professional');
                document.querySelector('.toggle-mode').textContent = 'üß∏ Mode Enfant';
            }
        }

        // R√©duire/Agrandir un bloc
        function toggleCollapse(blockId) {
            const block = document.getElementById(blockId);
            const btn = block.querySelector('.collapse-btn');
            block.classList.toggle('collapsed');
            if (block.classList.contains('collapsed')) {
                btn.textContent = '+';
            } else {
                btn.textContent = '‚àí';
            }
            // Sauvegarder l'√©tat
            localStorage.setItem('collapse-' + blockId, block.classList.contains('collapsed') ? 'collapsed' : 'expanded');
        }

        // Charger l'√©tat des blocs au d√©marrage
        function loadCollapseStates() {
            // Par d√©faut : tous r√©duits sauf treeBlock
            const defaultStates = {
                'addFormBlock': 'collapsed',
                'membersBlock': 'collapsed',
                'treeBlock': 'expanded'
            };

            Object.keys(defaultStates).forEach(blockId => {
                const state = localStorage.getItem('collapse-' + blockId) || defaultStates[blockId];
                const block = document.getElementById(blockId);
                if (block && state === 'collapsed') {
                    block.classList.add('collapsed');
                    block.querySelector('.collapse-btn').textContent = '+';
                }
            });
        }

        // Afficher les adultes sans conjoint
        function showSingles() {
            const modal = document.getElementById('singlesModal');
            const list = document.getElementById('singlesList');

            // Trouver les adultes (> 18 ans) sans conjoint
            const singles = familyMembers.filter(member => {
                const age = calculateAge(member.date_naissance);
                if (age === null || age <= 18) return false;
                if (member.decede) return false;

                // V√©rifier s'il a un conjoint
                const hasSpouse = familyRelations.some(rel =>
                    rel.relation_type === 'conjoint' &&
                    (rel.member_id === member.id || rel.related_member_id === member.id)
                );

                return !hasSpouse;
            });

            // Trier par nom
            singles.sort((a, b) => {
                const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                return nameA.localeCompare(nameB, 'fr');
            });

            if (singles.length === 0) {
                list.innerHTML = '<div class="no-singles">Tous les adultes ont un conjoint ! üíï</div>';
            } else {
                list.innerHTML = singles.map(member => {
                    const age = calculateAge(member.date_naissance);
                    return `
                        <div class="single-item" onclick="selectMemberAndClose('${member.id}')">
                            <span>${getAvatar(member.sexe, member.date_naissance)}</span>
                            <span>${member.prenom} ${member.nom}</span>
                            <span class="age">(${age} ans)</span>
                        </div>
                    `;
                }).join('');
            }

            modal.classList.add('show');
        }

        // S√©lectionner un membre et fermer la modal
        function selectMemberAndClose(memberId) {
            closeSinglesModal();
            selectMember(memberId);
        }

        // Fermer la modal
        function closeSinglesModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('singlesModal').classList.remove('show');
        }

        // Afficher les enfants (< 18 ans)
        function showChildren() {
            const modal = document.getElementById('childrenModal');
            const list = document.getElementById('childrenList');

            // Trouver les enfants (< 18 ans)
            const children = familyMembers.filter(member => {
                const age = calculateAge(member.date_naissance);
                if (age === null) return false;
                if (member.decede) return false;
                return age < 18;
            });

            // Trier par nom
            children.sort((a, b) => {
                const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                return nameA.localeCompare(nameB, 'fr');
            });

            if (children.length === 0) {
                list.innerHTML = '<div class="no-singles">Aucun enfant de moins de 18 ans</div>';
            } else {
                list.innerHTML = children.map(member => {
                    const age = calculateAge(member.date_naissance);
                    return `
                        <div class="single-item" onclick="selectMemberAndCloseChildren('${member.id}')">
                            <span>${getAvatar(member.sexe, member.date_naissance)}</span>
                            <span>${member.prenom} ${member.nom}</span>
                            <span class="age">(${age} ans)</span>
                        </div>
                    `;
                }).join('');
            }

            modal.classList.add('show');
        }

        // S√©lectionner un membre et fermer la modal enfants
        function selectMemberAndCloseChildren(memberId) {
            closeChildrenModal();
            selectMember(memberId);
        }

        // Fermer la modal enfants
        function closeChildrenModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('childrenModal').classList.remove('show');
        }

        // Afficher le calendrier des anniversaires
        function showBirthdayCalendar() {
            const modal = document.getElementById('birthdayModal');
            const calendar = document.getElementById('birthdayCalendar');

            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                               'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            const dayNames = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            // Collecter les anniversaires par mois/jour
            const birthdays = {};
            familyMembers.forEach(member => {
                if (!member.date_naissance) return;

                let month, day;
                const dateStr = member.date_naissance.trim();

                // Format JJ/MM/AAAA
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                    const parts = dateStr.split('/');
                    day = parseInt(parts[0]);
                    month = parseInt(parts[1]) - 1;
                }
                // Format AAAA-MM-JJ (ISO)
                else if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    const parts = dateStr.split('-');
                    month = parseInt(parts[1]) - 1;
                    day = parseInt(parts[2]);
                }
                // Juste une ann√©e - pas de jour pr√©cis
                else {
                    return;
                }

                const key = `${month}-${day}`;
                if (!birthdays[key]) {
                    birthdays[key] = [];
                }
                birthdays[key].push(member);
            });

            // G√©n√©rer le calendrier
            let html = '';
            const currentYear = new Date().getFullYear();

            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(currentYear, month, 1);
                const lastDay = new Date(currentYear, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                let startDay = firstDay.getDay();
                startDay = startDay === 0 ? 6 : startDay - 1; // Lundi = 0

                html += `<div class="month-card">
                    <div class="month-name">${monthNames[month]}</div>
                    <div class="days-header">
                        ${dayNames.map(d => `<div class="day-header">${d}</div>`).join('')}
                    </div>
                    <div class="days-grid">`;

                // Cellules vides avant le premier jour
                for (let i = 0; i < startDay; i++) {
                    html += '<div class="day-cell empty"></div>';
                }

                // Jours du mois
                for (let day = 1; day <= daysInMonth; day++) {
                    const key = `${month}-${day}`;
                    const dayBirthdays = birthdays[key];

                    if (dayBirthdays && dayBirthdays.length > 0) {
                        const initials = dayBirthdays.map(m =>
                            m.prenom.charAt(0).toUpperCase() + m.nom.charAt(0).toUpperCase()
                        ).join(' ');

                        const names = dayBirthdays.map(m => `${m.prenom} ${m.nom}`).join(', ');

                        let colorClass = 'multiple';
                        if (dayBirthdays.length === 1) {
                            colorClass = dayBirthdays[0].sexe === 'M' ? 'male' : 'female';
                        }

                        html += `<div class="day-cell has-birthday ${colorClass}"
                                     onclick="selectMemberFromCalendar('${dayBirthdays[0].id}')">
                            <span class="initials">${initials}</span>
                            <div class="birthday-tooltip">${names}</div>
                        </div>`;
                    } else {
                        html += `<div class="day-cell">${day}</div>`;
                    }
                }

                html += '</div></div>';
            }

            calendar.innerHTML = html;
            modal.classList.add('show');
        }

        // S√©lectionner un membre depuis le calendrier
        function selectMemberFromCalendar(memberId) {
            closeBirthdayCalendar();
            selectMember(memberId);
        }

        // Fermer le calendrier
        function closeBirthdayCalendar(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('birthdayModal').classList.remove('show');
        }

        // Labels pour l'affichage
        const relationLabels = {
            'pere': 'P√®re', 'mere': 'M√®re', 'fils': 'Fils', 'fille': 'Fille',
            'frere': 'Fr√®re', 'soeur': 'S≈ìur', 'demi-frere': 'Demi-fr√®re', 'demi-soeur': 'Demi-s≈ìur',
            'conjoint': 'Conjoint(e)', 'beau-pere': 'Beau-p√®re', 'belle-mere': 'Belle-m√®re',
            'grand-pere': 'Grand-p√®re', 'grand-mere': 'Grand-m√®re',
            'petit-fils': 'Petit-fils', 'petite-fille': 'Petite-fille',
            'oncle': 'Oncle', 'tante': 'Tante', 'cousin': 'Cousin', 'cousine': 'Cousine',
            'neveu': 'Neveu', 'niece': 'Ni√®ce', 'beau-fils': 'Beau-fils', 'belle-fille': 'Belle-fille'
        };

        // Afficher un message
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => messageDiv.innerHTML = '', 3000);
        }

        // Calculer l'√¢ge
        function calculateAge(birthDate) {
            if (!birthDate) return null;
            const today = new Date();
            let birthYear;

            // Si c'est juste une ann√©e (ex: "1985")
            if (/^\d{4}$/.test(birthDate.trim())) {
                birthYear = parseInt(birthDate.trim());
            }
            // Si c'est au format JJ/MM/AAAA ou DD/MM/YYYY
            else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(birthDate.trim())) {
                const parts = birthDate.trim().split('/');
                birthYear = parseInt(parts[2]);
            }
            // Si c'est au format AAAA-MM-JJ (ISO)
            else if (/^\d{4}-\d{2}-\d{2}$/.test(birthDate.trim())) {
                birthYear = parseInt(birthDate.trim().split('-')[0]);
            }
            // Sinon, essayer de parser comme date
            else {
                const birth = new Date(birthDate);
                if (isNaN(birth.getTime())) return null;
                birthYear = birth.getFullYear();
            }

            return today.getFullYear() - birthYear;
        }

        // Obtenir l'avatar
        function getAvatar(sexe, birthDate) {
            const age = calculateAge(birthDate);
            if (sexe === 'M') {
                if (age === null) return 'üë§';
                if (age < 12) return 'üë¶';
                if (age < 20) return 'üßë';
                if (age < 60) return 'üë®';
                return 'üë¥';
            } else {
                if (age === null) return 'üë§';
                if (age < 12) return 'üëß';
                if (age < 20) return 'üë©';
                if (age < 60) return 'üë©';
                return 'üëµ';
            }
        }

        // Obtenir la relation inverse
        function getInverseRelation(relationType, memberId) {
            const member = familyMembers.find(m => m.id === memberId);
            const sexe = member ? member.sexe : 'M';

            const inverseMap = {
                'pere': sexe === 'M' ? 'fils' : 'fille',
                'mere': sexe === 'M' ? 'fils' : 'fille',
                'fils': sexe === 'M' ? 'pere' : 'mere',
                'fille': sexe === 'M' ? 'pere' : 'mere',
                'frere': sexe === 'M' ? 'frere' : 'soeur',
                'soeur': sexe === 'M' ? 'frere' : 'soeur',
                'demi-frere': sexe === 'M' ? 'demi-frere' : 'demi-soeur',
                'demi-soeur': sexe === 'M' ? 'demi-frere' : 'demi-soeur',
                'conjoint': 'conjoint',
                'beau-pere': sexe === 'M' ? 'beau-fils' : 'belle-fille',
                'belle-mere': sexe === 'M' ? 'beau-fils' : 'belle-fille',
                'grand-pere': sexe === 'M' ? 'petit-fils' : 'petite-fille',
                'grand-mere': sexe === 'M' ? 'petit-fils' : 'petite-fille',
                'petit-fils': sexe === 'M' ? 'grand-pere' : 'grand-mere',
                'petite-fille': sexe === 'M' ? 'grand-pere' : 'grand-mere',
                'oncle': sexe === 'M' ? 'neveu' : 'niece',
                'tante': sexe === 'M' ? 'neveu' : 'niece',
                'cousin': sexe === 'M' ? 'cousin' : 'cousine',
                'cousine': sexe === 'M' ? 'cousin' : 'cousine'
            };
            return inverseMap[relationType] || relationType;
        }

        // Trouver les parents d'une personne
        function getParentsOf(personId) {
            const parents = [];
            familyRelations.forEach(rel => {
                if (rel.related_member_id === personId && ['pere', 'mere'].includes(rel.relation_type)) {
                    const parent = familyMembers.find(m => m.id === rel.member_id);
                    if (parent) parents.push({ member: parent, type: rel.relation_type });
                }
            });
            return parents;
        }

        // Trouver les enfants d'une personne
        function getChildrenOf(personId) {
            const children = [];
            familyRelations.forEach(rel => {
                if (rel.member_id === personId && ['pere', 'mere'].includes(rel.relation_type)) {
                    const child = familyMembers.find(m => m.id === rel.related_member_id);
                    if (child) {
                        const type = child.sexe === 'M' ? 'fils' : 'fille';
                        children.push({ member: child, type: type });
                    }
                }
            });
            return children;
        }

        // Obtenir les relations d'un membre avec calcul automatique
        function getMemberRelationsGrouped(memberId) {
            const relations = {
                parents: [],
                father: null,
                mother: null,
                grandparents: [],
                siblings: [],
                spouse: [],
                children: [],
                grandchildren: [],
                unclesAunts: [],
                fatherSideUnclesAunts: [],
                motherSideUnclesAunts: [],
                cousins: [],
                other: []
            };

            const addedIds = new Set([memberId]);

            // 1. Parents directs
            const myParents = getParentsOf(memberId);
            myParents.forEach(p => {
                relations.parents.push(p);
                addedIds.add(p.member.id);
                if (p.type === 'pere') {
                    relations.father = p.member;
                } else if (p.type === 'mere') {
                    relations.mother = p.member;
                }
            });

            // 2. Grands-parents (parents des parents)
            myParents.forEach(parent => {
                const grandparents = getParentsOf(parent.member.id);
                grandparents.forEach(gp => {
                    if (!addedIds.has(gp.member.id)) {
                        const type = gp.member.sexe === 'M' ? 'grand-pere' : 'grand-mere';
                        relations.grandparents.push({ member: gp.member, type: type });
                        addedIds.add(gp.member.id);
                    }
                });
            });

            // 3. Fr√®res et s≈ìurs (enfants des m√™mes parents)
            myParents.forEach(parent => {
                const siblings = getChildrenOf(parent.member.id);
                siblings.forEach(sib => {
                    if (!addedIds.has(sib.member.id)) {
                        const type = sib.member.sexe === 'M' ? 'frere' : 'soeur';
                        relations.siblings.push({ member: sib.member, type: type });
                        addedIds.add(sib.member.id);
                    }
                });
            });

            // 4. Oncles et tantes (fr√®res/s≈ìurs des parents)
            myParents.forEach(parent => {
                const parentParents = getParentsOf(parent.member.id);
                const isFatherSide = parent.type === 'pere';
                parentParents.forEach(gp => {
                    const unclesAunts = getChildrenOf(gp.member.id);
                    unclesAunts.forEach(ua => {
                        if (!addedIds.has(ua.member.id)) {
                            const type = ua.member.sexe === 'M' ? 'oncle' : 'tante';
                            const uaEntry = { member: ua.member, type: type };
                            relations.unclesAunts.push(uaEntry);
                            if (isFatherSide) {
                                relations.fatherSideUnclesAunts.push(uaEntry);
                            } else {
                                relations.motherSideUnclesAunts.push(uaEntry);
                            }
                            addedIds.add(ua.member.id);
                        }
                    });
                });
            });

            // 5. Cousins (enfants des oncles/tantes)
            relations.unclesAunts.forEach(ua => {
                const cousins = getChildrenOf(ua.member.id);
                cousins.forEach(cousin => {
                    if (!addedIds.has(cousin.member.id)) {
                        const type = cousin.member.sexe === 'M' ? 'cousin' : 'cousine';
                        relations.cousins.push({ member: cousin.member, type: type });
                        addedIds.add(cousin.member.id);
                    }
                });
            });

            // 6. Enfants directs
            const myChildren = getChildrenOf(memberId);
            myChildren.forEach(child => {
                if (!addedIds.has(child.member.id)) {
                    relations.children.push(child);
                    addedIds.add(child.member.id);
                }
            });

            // 7. Petits-enfants (enfants des enfants)
            relations.children.forEach(child => {
                const grandchildren = getChildrenOf(child.member.id);
                grandchildren.forEach(gc => {
                    if (!addedIds.has(gc.member.id)) {
                        const type = gc.member.sexe === 'M' ? 'petit-fils' : 'petite-fille';
                        relations.grandchildren.push({ member: gc.member, type: type });
                        addedIds.add(gc.member.id);
                    }
                });
            });

            // 8. Conjoint (relation directe)
            familyRelations.forEach(rel => {
                if ((rel.member_id === memberId || rel.related_member_id === memberId) && rel.relation_type === 'conjoint') {
                    const spouseId = rel.member_id === memberId ? rel.related_member_id : rel.member_id;
                    if (!addedIds.has(spouseId)) {
                        const spouse = familyMembers.find(m => m.id === spouseId);
                        if (spouse) {
                            relations.spouse.push({ member: spouse, type: 'conjoint' });
                            addedIds.add(spouseId);
                        }
                    }
                }
            });

            return relations;
        }

        // Cr√©er une carte de personne
        function createPersonCard(member, relationLabel = null, isCenter = false) {
            const age = calculateAge(member.date_naissance);
            const ageDisplay = age !== null ? `${age} ans` : '';
            const isDeceased = member.decede === true;
            const deceasedClass = isDeceased ? 'deceased' : '';
            return `
                <div class="person-card ${member.sexe === 'M' ? 'male' : 'female'} ${isCenter ? 'center' : ''} ${deceasedClass}"
                     onclick="selectMember('${member.id}')" data-id="${member.id}">
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteMember('${member.id}')" title="Supprimer">‚úï</button>
                    <div class="person-avatar">${getAvatar(member.sexe, member.date_naissance)}${isDeceased ? '<span style="position:absolute;top:-5px;right:-10px;font-size:0.5em;">üïäÔ∏è</span>' : ''}</div>
                    <div class="person-name">${member.prenom}</div>
                    ${ageDisplay ? `<div class="person-birth">${ageDisplay}</div>` : ''}
                    ${isDeceased ? '<div class="deceased-badge">üïäÔ∏è D√©c√©d√©(e)</div>' : ''}
                    ${relationLabel ? `<div class="person-relation-label">${relationLabel}</div>` : ''}
                </div>
            `;
        }

        // Cr√©er un niveau de l'arbre
        function createTreeLevel(members, labelText = '') {
            if (members.length === 0) return '';

            const cards = members.map(m => createPersonCard(m.member, relationLabels[m.type] || m.type)).join('');
            const singleClass = members.length === 1 ? 'single' : '';

            return `
                <div class="tree-row ${singleClass}">
                    ${cards}
                </div>
            `;
        }

        // Charger les membres
        async function loadFamilyMembers() {
            try {
                const [membersResult, relationsResult] = await Promise.all([
                    supabaseClient.from('family_members').select('*').order('date_naissance', { ascending: true }),
                    supabaseClient.from('family_relations').select('*')
                ]);

                if (membersResult.error) throw membersResult.error;

                familyMembers = membersResult.data || [];
                familyRelations = relationsResult.data || [];

                updateMembersChips();
                updatePersonSelect();

                updateRelationsManager();
                renderFamilyTree();
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('familyTree').innerHTML = `
                    <div class="no-members">
                        <span>üò¢</span>
                        <p>Erreur de connexion</p>
                    </div>
                `;
            }
        }

        // Mettre √† jour les chips des membres
        function updateMembersChips() {
            const container = document.getElementById('membersChips');

            if (familyMembers.length === 0) {
                container.innerHTML = '<p style="color: #636e72;">Aucun membre pour l\'instant</p>';
                return;
            }

            // Trier par ordre alphab√©tique
            const sortedMembers = [...familyMembers].sort((a, b) => {
                const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                return nameA.localeCompare(nameB, 'fr');
            });

            // Regrouper par premi√®re lettre du pr√©nom
            const groups = {};
            sortedMembers.forEach(member => {
                const firstLetter = member.prenom.charAt(0).toUpperCase();
                if (!groups[firstLetter]) {
                    groups[firstLetter] = [];
                }
                groups[firstLetter].push(member);
            });

            // G√©n√©rer le HTML avec les groupes
            let html = '';
            Object.keys(groups).sort((a, b) => a.localeCompare(b, 'fr')).forEach(letter => {
                html += `
                    <div class="letter-group">
                        <div class="letter-header">${letter}</div>
                        <div class="letter-members">
                            ${groups[letter].map(member => `
                                <div class="member-chip ${selectedMemberId === member.id ? 'active' : ''}"
                                     onclick="selectMember('${member.id}')">
                                    <span class="chip-avatar">${getAvatar(member.sexe, member.date_naissance)}</span>
                                    ${member.prenom} ${member.nom}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // S√©lectionner un membre
        function selectMember(memberId) {
            selectedMemberId = memberId;
            updateMembersChips();
            updateRelationsManager();
            renderFamilyTree();
        }

        // Mettre √† jour le gestionnaire de liens
        function updateRelationsManager() {
            const manager = document.getElementById('relationsManager');
            const nameSpan = document.getElementById('selectedMemberName');
            const listContainer = document.getElementById('relationsList');

            if (!selectedMemberId) {
                manager.style.display = 'none';
                return;
            }

            const member = familyMembers.find(m => m.id === selectedMemberId);
            if (!member) {
                manager.style.display = 'none';
                return;
            }

            // Trouver tous les liens de ce membre
            const memberRelations = [];
            familyRelations.forEach(rel => {
                if (rel.member_id === selectedMemberId) {
                    const relatedMember = familyMembers.find(m => m.id === rel.related_member_id);
                    if (relatedMember) {
                        memberRelations.push({
                            id: rel.id,
                            relatedMember: relatedMember,
                            type: rel.relation_type,
                            displayType: relationLabels[rel.relation_type] || rel.relation_type
                        });
                    }
                } else if (rel.related_member_id === selectedMemberId) {
                    const relatedMember = familyMembers.find(m => m.id === rel.member_id);
                    if (relatedMember) {
                        const inverseType = getInverseRelation(rel.relation_type, selectedMemberId);
                        memberRelations.push({
                            id: rel.id,
                            relatedMember: relatedMember,
                            type: inverseType,
                            displayType: relationLabels[inverseType] || inverseType
                        });
                    }
                }
            });

            nameSpan.textContent = member.prenom;

            // Remplir le formulaire de modification
            document.getElementById('editPrenom').value = member.prenom;
            document.getElementById('editNom').value = member.nom;
            document.getElementById('editDateNaissance').value = member.date_naissance || '';
            document.getElementById('editSexe').value = member.sexe;
            document.getElementById('editDecede').checked = member.decede === true;

            if (memberRelations.length === 0) {
                listContainer.innerHTML = '<p class="no-relations">Aucun lien pour cette personne</p>';
            } else {
                listContainer.innerHTML = memberRelations.map(rel => `
                    <div class="relation-item">
                        <span class="relation-type">${rel.displayType}</span>
                        <span class="relation-text">de ${rel.relatedMember.prenom} ${rel.relatedMember.nom}</span>
                        <button class="relation-delete-btn" onclick="deleteRelation('${rel.id}', '${rel.relatedMember.prenom}')" title="Supprimer ce lien">‚úï</button>
                    </div>
                `).join('');
            }

            // Mettre √† jour le select des personnes (exclure la personne s√©lectionn√©e)
            updateNewRelationSelect();

            manager.style.display = 'block';
        }

        // Mettre √† jour le select pour ajouter un nouveau lien
        function updateNewRelationSelect() {
            const select = document.getElementById('newRelatedPerson');
            select.innerHTML = '<option value="">Personne...</option>';

            familyMembers
                .filter(m => m.id !== selectedMemberId)
                .sort((a, b) => {
                    const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                    const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                    return nameA.localeCompare(nameB, 'fr');
                })
                .forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = `${member.prenom} ${member.nom}`;
                    select.appendChild(option);
                });

            // R√©initialiser les s√©lections
            document.getElementById('newRelationType').value = '';
        }

        // Ajouter un nouveau lien
        async function addNewRelation() {
            const relationType = document.getElementById('newRelationType').value;
            const relatedPersonId = document.getElementById('newRelatedPerson').value;

            if (!relationType || !relatedPersonId) {
                showMessage('Choisis un type de lien et une personne', 'error');
                return;
            }

            const relatedMember = familyMembers.find(m => m.id === relatedPersonId);

            try {
                const { error } = await supabaseClient
                    .from('family_relations')
                    .insert([{
                        member_id: selectedMemberId,
                        related_member_id: relatedPersonId,
                        relation_type: relationType
                    }]);

                if (error) throw error;

                showMessage(`Lien avec ${relatedMember.prenom} ajout√© !`, 'success');

                // R√©initialiser le formulaire
                document.getElementById('newRelationType').value = '';
                document.getElementById('newRelatedPerson').value = '';

                await loadFamilyMembers();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de l\'ajout du lien', 'error');
            }
        }

        // Supprimer un lien
        async function deleteRelation(relationId, relatedName) {
            if (!confirm(`Supprimer le lien avec ${relatedName} ?`)) return;

            try {
                const { error } = await supabaseClient
                    .from('family_relations')
                    .delete()
                    .eq('id', relationId);

                if (error) throw error;

                showMessage(`Lien avec ${relatedName} supprim√©`, 'success');
                await loadFamilyMembers();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de la suppression du lien', 'error');
            }
        }

        // Enregistrer les modifications d'un membre
        async function saveEditMember() {
            if (!selectedMemberId) return;

            const prenom = document.getElementById('editPrenom').value.trim();
            const nom = document.getElementById('editNom').value.trim();
            const dateNaissance = document.getElementById('editDateNaissance').value || null;
            const sexe = document.getElementById('editSexe').value;
            const decede = document.getElementById('editDecede').checked;

            if (!prenom || !nom || !sexe) {
                showMessage('Remplis au moins le pr√©nom, le nom et le sexe', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('family_members')
                    .update({
                        prenom: prenom,
                        nom: nom,
                        date_naissance: dateNaissance,
                        sexe: sexe,
                        decede: decede
                    })
                    .eq('id', selectedMemberId);

                if (error) throw error;

                showMessage(`${prenom} a √©t√© modifi√©(e) ! ‚úÖ`, 'success');
                await loadFamilyMembers();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de la modification', 'error');
            }
        }

        // Mettre √† jour les selects de parents
        function updatePersonSelect() {
            const pereSelect = document.getElementById('pereId');
            const mereSelect = document.getElementById('mereId');

            pereSelect.innerHTML = '<option value="">Aucun p√®re</option>';
            mereSelect.innerHTML = '<option value="">Aucune m√®re</option>';

            // Trier par ordre alphab√©tique
            const sortedMembers = [...familyMembers].sort((a, b) => {
                const nameA = `${a.prenom} ${a.nom}`.toLowerCase();
                const nameB = `${b.prenom} ${b.nom}`.toLowerCase();
                return nameA.localeCompare(nameB, 'fr');
            });

            sortedMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = `${member.prenom} ${member.nom}`;

                if (member.sexe === 'M') {
                    pereSelect.appendChild(option);
                } else {
                    mereSelect.appendChild(option);
                }
            });
        }

        // Afficher l'arbre g√©n√©alogique
        function renderFamilyTree() {
            const container = document.getElementById('familyTree');

            if (familyMembers.length === 0) {
                container.innerHTML = `
                    <div class="no-members">
                        <span>üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                        <p>Aucun membre dans la famille !</p>
                        <p style="font-size: 0.9em;">Ajoute quelqu'un pour commencer</p>
                    </div>
                `;
                return;
            }

            const centerMember = familyMembers.find(m => m.id === selectedMemberId);
            if (!centerMember) {
                container.innerHTML = `
                    <div class="no-members">
                        <span>üëÜ</span>
                        <p>S√©lectionne une personne dans la liste</p>
                        <p style="font-size: 0.8em; color: #636e72;">pour afficher son arbre familial</p>
                    </div>
                `;
                return;
            }

            const relations = getMemberRelationsGrouped(selectedMemberId);

            let html = '';

            // G√©n√©ration 1: Grands-parents (seulement s'il y en a)
            if (relations.grandparents.length > 0) {
                html += `
                    <div class="tree-level-wrapper">
                        <div class="generation-header">
                            <span class="gen-emoji">üë¥üëµ</span>Grands-parents
                        </div>
                        <div class="tree-level">
                            ${createTreeLevel(relations.grandparents)}
                        </div>
                    </div>
                    <div class="vertical-line"></div>
                `;
            }

            // G√©n√©ration 2: Parents + Oncles/Tantes (seulement s'il y en a)
            if (relations.parents.length > 0 || relations.unclesAunts.length > 0) {
                const hasFatherGroup = relations.father && relations.fatherSideUnclesAunts.length > 0;
                const hasMotherGroup = relations.mother && relations.motherSideUnclesAunts.length > 0;

                html += `
                    <div class="tree-level-wrapper">
                        <div class="generation-header">
                            <span class="gen-emoji">üë®üë©</span>Parents${relations.unclesAunts.length > 0 ? ' & Oncles/Tantes' : ''}
                        </div>
                        <div class="tree-level">
                            <div class="parents-row">
                                ${relations.father ? `
                                    <div class="sibling-group${!hasFatherGroup ? ' no-siblings' : ''}">
                                        ${relations.fatherSideUnclesAunts.map(m => createPersonCard(m.member, relationLabels[m.type])).join('')}
                                        ${createPersonCard(relations.father, 'P√®re')}
                                    </div>
                                ` : ''}
                                ${relations.mother ? `
                                    <div class="sibling-group${!hasMotherGroup ? ' no-siblings' : ''}">
                                        ${createPersonCard(relations.mother, 'M√®re')}
                                        ${relations.motherSideUnclesAunts.map(m => createPersonCard(m.member, relationLabels[m.type])).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="vertical-line"></div>
                `;
            }

            // G√©n√©ration 3: Moi + Conjoint + Fr√®res/S≈ìurs (toujours affich√©)
            html += `
                <div class="tree-level-wrapper">
                    <div class="generation-header" style="background: linear-gradient(135deg, #e84393 0%, #fd79a8 100%);">
                        <span class="gen-emoji">‚≠ê</span>${centerMember.prenom}
                    </div>
                    <div class="tree-level">
                        <div class="tree-row single" style="gap: 30px;">
                            ${relations.siblings.length > 0 ? `
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                                    ${relations.siblings.map(m => createPersonCard(m.member, relationLabels[m.type])).join('')}
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; justify-content: center;">
                                ${createPersonCard(centerMember, null, true)}
                                ${relations.spouse.map(m => createPersonCard(m.member, relationLabels[m.type])).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // G√©n√©ration 4: Enfants (seulement s'il y en a)
            if (relations.children.length > 0) {
                html += `
                    <div class="vertical-line"></div>
                    <div class="tree-level-wrapper">
                        <div class="generation-header">
                            <span class="gen-emoji">üë¶üëß</span>Enfants
                        </div>
                        <div class="tree-level">
                            ${createTreeLevel(relations.children)}
                        </div>
                    </div>
                `;
            }

            // G√©n√©ration 5: Petits-enfants (seulement s'il y en a)
            if (relations.grandchildren.length > 0) {
                html += `
                    <div class="vertical-line"></div>
                    <div class="tree-level-wrapper">
                        <div class="generation-header">
                            <span class="gen-emoji">üë∂</span>Petits-enfants
                        </div>
                        <div class="tree-level">
                            ${createTreeLevel(relations.grandchildren)}
                        </div>
                    </div>
                `;
            }

            // Autres relations
            if (relations.other.length > 0) {
                html += `
                    <div class="vertical-line"></div>
                    <div class="tree-level-wrapper">
                        <div class="generation-header" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">
                            <span class="gen-emoji">üë•</span>Autres liens
                        </div>
                        <div class="tree-level">
                            ${createTreeLevel(relations.other)}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Ajouter un membre
        async function addMember(event) {
            event.preventDefault();

            const form = event.target;
            const memberData = {
                prenom: form.prenom.value.trim(),
                nom: form.nom.value.trim(),
                date_naissance: form.dateNaissance.value || null,
                sexe: form.sexe.value,
                decede: form.decede.checked
            };

            const pereId = form.pereId.value;
            const mereId = form.mereId.value;

            try {
                const { data: newMember, error: memberError } = await supabaseClient
                    .from('family_members')
                    .insert([memberData])
                    .select()
                    .single();

                if (memberError) throw memberError;

                // Ajouter les relations avec les parents
                const relationsToAdd = [];

                if (pereId) {
                    relationsToAdd.push({
                        member_id: pereId,
                        related_member_id: newMember.id,
                        relation_type: 'pere'
                    });
                }

                if (mereId) {
                    relationsToAdd.push({
                        member_id: mereId,
                        related_member_id: newMember.id,
                        relation_type: 'mere'
                    });
                }

                if (relationsToAdd.length > 0) {
                    await supabaseClient
                        .from('family_relations')
                        .insert(relationsToAdd);
                }

                showMessage(`${memberData.prenom} a √©t√© ajout√©(e) ! üéâ`, 'success');
                form.reset();

                // S√©lectionner le nouveau membre
                selectedMemberId = newMember.id;
                await loadFamilyMembers();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de l\'ajout', 'error');
            }
        }

        // Supprimer un membre
        async function deleteMember(id) {
            const member = familyMembers.find(m => m.id === id);
            if (!confirm(`Supprimer ${member.prenom} de l'arbre ?`)) return;

            try {
                await supabaseClient
                    .from('family_relations')
                    .delete()
                    .or(`member_id.eq.${id},related_member_id.eq.${id}`);

                await supabaseClient
                    .from('family_members')
                    .delete()
                    .eq('id', id);

                showMessage(`${member.prenom} a √©t√© retir√©(e)`, 'success');

                if (selectedMemberId === id) {
                    selectedMemberId = null;
                }

                await loadFamilyMembers();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors de la suppression', 'error');
            }
        }

        // Initialisation
        loadModePreference();
        loadCollapseStates();
        document.getElementById('addMemberForm').addEventListener('submit', addMember);
        loadFamilyMembers();
    </script>
</body>
</html>
